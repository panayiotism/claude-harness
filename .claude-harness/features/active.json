{
  "version": 1,
  "features": [
    {
      "id": "feature-008",
      "name": "Agent Lifecycle Hooks Integration (Claude Code v2.1.0)",
      "description": "Integrate Claude Code v2.1.0 agent lifecycle hooks into the harness for automatic memory persistence during /implement loops. Includes PreToolUse (check learned rules), PostToolUse (record file changes), Stop (auto-checkpoint), and SessionStart with once:true.",
      "priority": 1,
      "passes": true,
      "verification": [
        "PreToolUse hook validates against learned rules before tool execution",
        "PostToolUse hook records file modifications to procedural memory",
        "Stop hook auto-checkpoints on loop end",
        "SessionStart hook only runs once per session (once: true)",
        "Hooks execute during /implement loops",
        "Memory updates are persisted correctly"
      ],
      "verificationCommands": {
        "build": null,
        "tests": null,
        "lint": null,
        "typecheck": null,
        "custom": [
          "cat hooks/hooks.json | grep -q 'once'",
          "test -f hooks/pre-tool-check.sh",
          "test -f hooks/post-tool-record.sh",
          "test -f hooks/loop-checkpoint.sh"
        ]
      },
      "maxAttempts": 10,
      "relatedFiles": [
        "hooks/hooks.json",
        "hooks/pre-tool-check.sh",
        "hooks/post-tool-record.sh",
        "hooks/loop-checkpoint.sh",
        "hooks/session-start.sh",
        "commands/implement.md"
      ],
      "github": {
        "issueNumber": 18,
        "prNumber": null,
        "branch": "feature/feature-008-agent-hooks"
      },
      "createdAt": "2026-01-08T17:48:00Z",
      "phase": "planned",
      "plan": {
        "steps": [
          {
            "step": 1,
            "description": "Update hooks/hooks.json - Add once:true to SessionStart hook",
            "files": ["hooks/hooks.json"],
            "details": "Add 'once': true to prevent duplicate memory compilation on session resume"
          },
          {
            "step": 2,
            "description": "Update hooks/hooks.json - Add PreToolUse hook",
            "files": ["hooks/hooks.json"],
            "details": "Add PreToolUse hook that runs pre-tool-check.sh before Write/Edit/Bash tools"
          },
          {
            "step": 3,
            "description": "Update hooks/hooks.json - Add PostToolUse hook",
            "files": ["hooks/hooks.json"],
            "details": "Add PostToolUse hook that runs post-tool-record.sh after Write/Edit tools"
          },
          {
            "step": 4,
            "description": "Update hooks/hooks.json - Add Stop hook",
            "files": ["hooks/hooks.json"],
            "details": "Add Stop hook that runs loop-checkpoint.sh when agent loop ends"
          },
          {
            "step": 5,
            "description": "Create hooks/pre-tool-check.sh",
            "files": ["hooks/pre-tool-check.sh"],
            "details": "Shell script that reads learned rules from memory/learned/rules.json and validates proposed tool use against them. Outputs warnings via systemMessage if rules violated."
          },
          {
            "step": 6,
            "description": "Create hooks/post-tool-record.sh",
            "files": ["hooks/post-tool-record.sh"],
            "details": "Shell script that records file modifications to memory/procedural/ after Write/Edit tools. Captures file paths, timestamps, and context for future reference."
          },
          {
            "step": 7,
            "description": "Create hooks/loop-checkpoint.sh",
            "files": ["hooks/loop-checkpoint.sh"],
            "details": "Shell script that auto-saves working context and optionally stages changes when an agent loop completes (Stop hook). Persists decisions to episodic memory."
          },
          {
            "step": 8,
            "description": "Bump plugin version to 3.4.0",
            "files": [".claude-plugin/plugin.json"],
            "details": "Update version for new lifecycle hooks feature"
          },
          {
            "step": 9,
            "description": "Test hook execution",
            "files": [],
            "details": "Verify hooks fire correctly during /implement loops and memory is persisted"
          }
        ],
        "estimatedFiles": [
          "hooks/hooks.json",
          "hooks/pre-tool-check.sh",
          "hooks/post-tool-record.sh",
          "hooks/loop-checkpoint.sh",
          ".claude-plugin/plugin.json"
        ],
        "impactScore": "medium",
        "risks": [
          "Hook timeout could interrupt tool execution if scripts are slow",
          "JSON parsing in shell scripts may be fragile",
          "Claude Code hook input format may differ from expectations"
        ],
        "mitigations": [
          "Keep hook scripts fast (<5 seconds), use reasonable timeouts",
          "Use jq for robust JSON parsing where available, fallback to grep",
          "Test with actual Claude Code v2.1.0 to validate hook input format"
        ],
        "dependencies": [
          "Claude Code v2.1.0 with agent lifecycle hooks support",
          "Existing memory layer structure (.claude-harness/memory/)"
        ]
      },
      "tests": {
        "generated": false,
        "files": []
      }
    }
  ],
  "fixes": []
}
